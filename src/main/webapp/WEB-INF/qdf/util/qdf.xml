<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE queryset PUBLIC "-//HP Software Professional Service//DTD Query Configuration 1.0//EN" "D:\Leo\MyWork\hpps-qad\src\main\resources\hpps\qad\qdf.dtd">
<!--
********************************************************************************
CODING CONVENTIONS 编码规范
==========================
1. query name 只能包含大写字母、数字、下划线
2. query name 命名规则：<前缀>_<查询对象>_<查询内容>_[结果类型]_[查询条件]
*     <前缀>: 以namespace的简称为前缀，例如"WIN"、"RS6K"、"PLAT"、"COM" 不超过4个字母
*  <查询对象>: 查询的主要对象，例如SERVER（服务器）、AUDIT（审计）、USER（用户）
*  <查询内容>: 查询对象的内容
*  [结果类型]: 相同的查询对象和内容，SUM/COUNT、LIST、DETAIL 构成三级主从结构
        SUM - 概要信息，一般包含2~5个字段，用户的第一入口，一般用于Tab显示
       LIST - 列表信息，包含5~10个字段，用户通过SUM进入，一般用于Table或Grid显示
     DETAIL - 详细信息，包含5~20个字段，用户点击LIST某项进入，一般用Form显示
*  [查询条件]：说明查询的依据，例如BY_DATE, BY_RULE, BY_STATUS
3. SQL语句中表的别名，采用表名的各个单词首写字母。
   例如SAS_SERVERS别名为ss，SAS_USER_GROUPS别名为sug，不得采用a，b，c等无意义的别名。

CHANGE LOG 变更记录
==========================
@2012/05/23, Leo Liao, created
********************************************************************************
-->
<queryset>
    <query name="UTIL_CHECK_DB_CONN">
        <description>测试数据库连接</description>
        <sql>
            <![CDATA[
SELECT SYSDATE FROM DUAL
                ]]>
        </sql>
    </query>
    <query name="UTIL_SA_SERVER_GROUP_LIST" description="列出Public设备组">
        <sql>
            <![CDATA[
select item_id,
       group_name,
       /*group_long_name*/
       group_desc,
       parent_group_item_id
       /*group_path*/
  from cmdb_data.sas_server_groups
 where     (latest_flag = 1)
       and allow_servers = 'Y'
       and group_path like 'Device Groups Public%'
                ]]>
        </sql>
    </query>
    <query name="UTIL_SA_SERVER_LIST_BY_CUSTOMER">
        <description>根据Customer列出设备</description>
        <sql>
            <![CDATA[
select ss.item_id as server_id, ss.host_name, ss.notes, ssca.attribute_short_value as server_admin
from cmdb_data.sas_servers ss
--从sas_server_cust_attributes查找管理员信息
left join cmdb_data.sas_server_cust_attributes ssca on ss.item_id = ssca.item_id and ssca.latest_flag=1 and to_char(ssca.end_date, 'yyyy') = '4000' and ssca.attribute_name='(P)Administrator'
--根据item_id过滤Server
where ss.latest_flag=1 and ss.item_id in(
--从sas_server_customers查找一个Customer下的Server item_id
select ssc.item_id from cmdb_data.sas_server_customers ssc
inner join cmdb_data.sas_customers sc on ssc.customer_item_id = sc.item_id
where ssc.latest_flag=1 and (ssc.customer_item_id=(:customer_id))
)
                ]]>
        </sql>
    </query>
    <query name="UTIL_SA_SERVER_COUNT_BY_ADMIN">
        <description>根据管理员统计设备</description>
        <sql>
            <![CDATA[
SELECT ssca.attribute_short_value AS server_admin, COUNT(ssca.item_id) AS server_count
    FROM cmdb_data.sas_server_cust_attributes ssca
   WHERE ssca.latest_flag = 1
     AND TO_CHAR(ssca.end_date, 'yyyy') = '4000'
     AND ssca.attribute_name = '(P)Administrator'
GROUP BY ssca.attribute_short_value
                ]]>
        </sql>
    </query>
    <query name="GET_SAS_SERVER_BY_ID">
        <description>设备</description>
        <sql>
            <![CDATA[
select *
  from cmdb_data.sas_servers
 where     (latest_flag = 1)
       and item_id = :item_id
                ]]>
        </sql>
    </query>
    <query name="UTIL_SA_CUSTOMER_LIST">
        <description>列出SA Customers</description>
        <sql><![CDATA[
select item_id as customer_id,
       customer_name
--       customer_key,
--       customer_id
  from cmdb_data.sas_customers sc
 where TO_CHAR(end_of_life_date, 'yyyy') = '4000'
 ]]>
        </sql>
    </query>
    <query name="LIST_SVR_AUDIT_RESULTS">
        <description>列出审计明细</description>
        <sql>
            <![CDATA[
select item_id,
       begin_date,
       audit_item_id,
       rule_item,
       expected_value,
       actual_value,
       is_compliant,
       code
  from cmdb_data.sas_svr_audit_results ssar
  where 1=1 and (TO_CHAR (ssar.begin_date, 'yyyy-mm-dd hh:mi:ss') between (:begin_time) and (:end_time))
        ]]>
        </sql>
    </query>
    <query name="SUM_AUDIT_COMP_BY_SERVER">
        <description>在SQL_COUNT_AUDIT_COMP_BY_SERVER的基础上增加主机名，管理员信息</description>
        <sql>
            <![CDATA[
select ss.item_id as server_id,
       ss.host_name,
       ssca.attribute_short_value as admin_name,
       total_non_comp,
       total_comp,
       total_scan_failed,
       total_all
  from cmdb_data.sas_servers ss
       inner join (                 /* Call @SQL_COUNT_AUDIT_COMP_BY_SERVER */
                   select   item_id,
                            SUM (is_non_comp) as total_non_comp,
                            SUM (is_compliant) as total_comp,
                            SUM (is_scan_failed) as total_scan_failed,
                              SUM (is_non_comp)
                            + SUM (is_scan_failed)
                            + SUM (is_compliant)
                               as total_all
                       from cmdb_data.sas_svr_comp_fact scf
                      where     latest_flag = 1     /* filter valid records */
                            and policy_type_id = 2
                            and policy_item_id > 0
                            and total_rule_num > 0 /* filter only valid audit */
                            and item_id in
                                   (select server_item_id
                                      from cmdb_data.sas_server_group_members
                                     where item_id in
                                              (select item_id
                                                 from cmdb_data.sas_server_groups
                                                where group_long_name like
                                                         'Windows%')) /* filter servers by specific device group, customer or other creteria */
                            and TO_CHAR (scf.begin_date, 'yyyy-mm-dd hh:mi:ss') between :begin_time
                                                                                    and :end_time /* filter records during specific period */
                   group by item_id
                   order by item_id) group_scf
          on group_scf.item_id = ss.item_id
       left join cmdb_data.sas_server_cust_attributes ssca
          on     (ssca.latest_flag = 1)
             and ssca.item_id = ss.item_id
             and ssca.attribute_name = '(P)Administrator'
 where ss.latest_flag = 1
            ]]>
        </sql>
    </query>
    <query name="R1002">
        <description>查找机器合规详细列表</description>
        <sql>
            <![CDATA[
select
    sscf.item_id as server_id, ss.host_name, ssca.attribute_short_value as admin_name,
    to_char(sscf.begin_date,'yyyy-mm-dd hh:mi:ss') as check_date, sap.audit_policy_name, sscf.policy_type_id, sscf.latest_test_time, sscf.policy_item_id,
    sscf.total_rule_num, sscf.failed_rule_num, /*sscf.exp_rule_num,*/
    sscf.is_compliant, sscf.is_non_comp, sscf.is_part_comp, sscf.is_scan_failed /*, sscf.job_item_id*/
from cmdb_data.sas_svr_comp_fact sscf
inner join cmdb_data.sas_servers ss on (ss.latest_flag = 1) and sscf.item_id = ss.item_id
inner join cmdb_data.sas_audit_policies sap on (sap.latest_flag = 1) and sap.item_id = sscf.policy_item_id
left join cmdb_data.sas_server_cust_attributes ssca on (ssca.latest_flag = 1) and ssca.item_id = sscf.item_id and ssca.attribute_id='(P)Administrator'
where (sscf.latest_flag = 1) and sscf.policy_type_id=2 and sscf.policy_item_id>0  and total_rule_num>0
    and sscf.item_id=:server_id
            ]]>
        </sql>
    </query>
    <query name="COUNT_AUDIT_COMP_BY_SERVER_AND_POLICY_VERBOSE">
        <description>
            根据机器、审计项目，统计合规/不合规/失败次数，以供计算合规比率。
            显示主机名，管理员信息。
        </description>
        <sql><![CDATA[
select ss.item_id as server_id,
       ss.host_name,
       policy_item_id,
       --       sap.*,
       sap.audit_policy_name,
       sap.ruleset_type_key,
       sap.description,
       ssca.attribute_short_value as admin_name,
       total_non_comp,
       total_comp,
       total_scan_failed,
       total_all
  from cmdb_data.sas_servers ss
       inner join (          /* Call @COUNT_AUDIT_COMP_BY_SERVER_AND_POLICY */
                   select   item_id,
                            policy_item_id,
                            SUM(is_non_comp) as total_non_comp,
                            SUM(is_compliant) as total_comp,
                            SUM(is_scan_failed) as total_scan_failed,
                            (SUM(is_non_comp) + SUM(is_scan_failed) + SUM(
                             is_compliant))
                               as total_all
                       from cmdb_data.sas_svr_comp_fact scf
                      where     (latest_flag = 1)   /* filter valid records */
                            and (    policy_type_id = 2
                                 and policy_item_id > 0
                                 and total_rule_num > 0) /* filter only valid audit */
                            and item_id in
                                   (select server_item_id
                                      from cmdb_data.sas_server_group_members
                                     where item_id in
                                              (select item_id
                                                 from cmdb_data.sas_server_groups
                                                where group_long_name like
                                                         'Windows%')) /* filter servers by specific device group, customer or other creteria */
                            and TO_CHAR(scf.begin_date, 'yyyy-mm-dd hh:mi:ss') between :begin_time
                                                                                   and :end_time /* filter records during specific period */
                   group by item_id, policy_item_id
                   order by item_id, policy_item_id) group_scf
          on group_scf.item_id = ss.item_id
       left join cmdb_data.sas_server_cust_attributes ssca
          on     (ssca.latest_flag = 1)
             and ssca.item_id = ss.item_id
             and ssca.attribute_name = '(P)Administrator'
       left join cmdb_data.sas_audit_policies sap
          on     (sap.latest_flag = 1)
             and group_scf.policy_item_id = sap.item_id
 where ss.latest_flag = 1 and ss.item_id=:server_id
        ]]>
        </sql>
    </query>
    <query name="COUNT_AUDIT_COMP_BY_SERVER">
        <description>SQL_COUNT_AUDIT_COMP_BY_SERVER，根据机器统计合规/不合规/失败次数、和检查总次数。以供计算合规/不合规/失败比率</description>
        <sql>
            <![CDATA[
/* Formatted on 3/28/2012 11:17:09 AM (QP5 v5.185.11230.41888) */
  select item_id,
         SUM (is_non_comp) as total_non_comp,
         SUM (is_compliant) as total_comp,
         SUM (is_scan_failed) as total_scan_failed,
         SUM (is_non_comp) + SUM (is_scan_failed) + SUM (is_compliant)
            as total_all
    from cmdb_data.sas_svr_comp_fact scf
   where                                            /* filter valid records */
        latest_flag = 1
         /* filter only valid audit */
         and policy_type_id = 2
         and policy_item_id > 0
         and total_rule_num > 0
         /* filter servers by specific device group, customer or other creteria */
         and item_id in
                (select server_item_id
                   from cmdb_data.sas_server_group_members
                  where item_id in (select item_id
                                      from cmdb_data.sas_server_groups
                                     where group_long_name like 'Windows%'))
/* filter records during specific period */
/* and to_char(s1.begin_date,'yyyy-mm-dd hh:mi:ss') between '' and '' */
group by item_id
            ]]>
        </sql>
    </query>
    <query name="UTIL_SA_SERVER_COUNT_BY_PLATFORM">
        <sql><![CDATA[
select sp.os_name, count(ssp.item_id) as total_servers from cmdb_data.sas_server_platforms ssp
left join cmdb_data.sas_platforms sp on ssp.os_item_id = sp.item_id
where ssp.latest_flag = 1
group by os_name
            ]]></sql>
    </query>
    <query name="SUM_AUDIT_COMP_BY_SERVER_DATE">
        <sql><![CDATA[
select item_id,
         TO_CHAR(begin_date, 'yyyy-mm-dd') as audit_date,
         SUM(is_non_comp) as total_non_comp,
         SUM(is_compliant) as total_comp,
         SUM(is_scan_failed) as total_scan_failed,
         SUM(is_non_comp) + SUM(is_scan_failed) + SUM(is_compliant)
            as total_all
    from cmdb_data.sas_svr_comp_fact scf
   where     (latest_flag = 1)                      /* filter valid records */
         and (    policy_type_id = 2
              and policy_item_id > 0
              and total_rule_num > 0)            /* filter only valid audit */
         and item_id in
                (select server_item_id
                   from cmdb_data.sas_server_group_members
                  where item_id in (select item_id
                                      from cmdb_data.sas_server_groups
                                     where group_long_name like 'Windows%')) /* filter servers by specific device group, customer or other creteria */
         and TO_CHAR(scf.begin_date, 'yyyy-mm-dd hh:mi:ss') between :begin_time
                                                                and :end_time /* filter records during specific period */
group by item_id, TO_CHAR(begin_date, 'yyyy-mm-dd')
        ]]></sql>
    </query>


</queryset>